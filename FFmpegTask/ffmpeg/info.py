"""
a = {
    "streams": [
        {
            "index": 0,
            "codec_name": "av1",
            "codec_long_name": "Alliance for Open Media AV1",
            "profile": "Main",
            "codec_type": "video",
            "codec_tag_string": "[0][0][0][0]",
            "codec_tag": "0x0000",
            "width": 1280,
            "height": 800,
            "coded_width": 1280,
            "coded_height": 800,
            "closed_captions": 0,
            "film_grain": 0,
            "has_b_frames": 0,
            "sample_aspect_ratio": "1:1",
            "display_aspect_ratio": "8:5",
            "pix_fmt": "yuv420p",
            "level": 8,
            "color_range": "tv",
            "color_space": "bt709",
            "color_transfer": "bt709",
            "color_primaries": "bt709",
            "chroma_location": "left",
            "field_order": "progressive",
            "refs": 1,
            "r_frame_rate": "60/1",
            "avg_frame_rate": "60/1",
            "time_base": "1/1000",
            "start_pts": 38,
            "start_time": "0.038000",
            "extradata_size": 4,
            "disposition": {
                "default": 1,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "ENCODER": "Lavc59.18.100 libaom-av1",
                "DURATION": "00:00:10.538000000"
            }
        },
        {
            "index": 1,
            "codec_name": "aac",
            "codec_long_name": "AAC (Advanced Audio Coding)",
            "profile": "LC",
            "codec_type": "audio",
            "codec_tag_string": "[0][0][0][0]",
            "codec_tag": "0x0000",
            "sample_fmt": "fltp",
            "sample_rate": "48000",
            "channels": 2,
            "channel_layout": "stereo",
            "bits_per_sample": 0,
            "r_frame_rate": "0/0",
            "avg_frame_rate": "0/0",
            "time_base": "1/1000",
            "start_pts": 0,
            "start_time": "0.000000",
            "extradata_size": 5,
            "disposition": {
                "default": 1,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "title": "simple_aac",
                "ENCODER": "Lavc59.18.100 aac",
                "DURATION": "00:00:10.496000000"
            }
        },
        {
            "index": 2,
            "codec_name": "ass",
            "codec_long_name": "ASS (Advanced SSA) subtitle",
            "codec_type": "subtitle",
            "codec_tag_string": "[0][0][0][0]",
            "codec_tag": "0x0000",
            "r_frame_rate": "0/0",
            "avg_frame_rate": "0/0",
            "time_base": "1/1000",
            "start_pts": 0,
            "start_time": "0.000000",
            "duration_ts": 10538,
            "duration": "10.538000",
            "extradata_size": 915,
            "disposition": {
                "default": 1,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "DURATION": "00:00:10.042000000"
            }
        },
        {
            "index": 3,
            "codec_name": "subrip",
            "codec_long_name": "SubRip subtitle",
            "codec_type": "subtitle",
            "codec_tag_string": "[0][0][0][0]",
            "codec_tag": "0x0000",
            "r_frame_rate": "0/0",
            "avg_frame_rate": "0/0",
            "time_base": "1/1000",
            "start_pts": 0,
            "start_time": "0.000000",
            "duration_ts": 10538,
            "duration": "10.538000",
            "disposition": {
                "default": 0,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "DURATION": "00:00:10.042000000"
            }
        },
        {
            "index": 4,
            "codec_name": "ass",
            "codec_long_name": "ASS (Advanced SSA) subtitle",
            "codec_type": "subtitle",
            "codec_tag_string": "[0][0][0][0]",
            "codec_tag": "0x0000",
            "r_frame_rate": "0/0",
            "avg_frame_rate": "0/0",
            "time_base": "1/1000",
            "start_pts": 21,
            "start_time": "0.021000",
            "extradata_size": 915,
            "disposition": {
                "default": 0,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "DURATION": "00:00:10.021000000"
            }
        },
        {
            "index": 5,
            "codec_name": "subrip",
            "codec_long_name": "SubRip subtitle",
            "codec_type": "subtitle",
            "codec_tag_string": "[0][0][0][0]",
            "codec_tag": "0x0000",
            "r_frame_rate": "0/0",
            "avg_frame_rate": "0/0",
            "time_base": "1/1000",
            "start_pts": 21,
            "start_time": "0.021000",
            "disposition": {
                "default": 0,
                "dub": 0,
                "original": 0,
                "comment": 0,
                "lyrics": 0,
                "karaoke": 0,
                "forced": 0,
                "hearing_impaired": 0,
                "visual_impaired": 0,
                "clean_effects": 0,
                "attached_pic": 0,
                "timed_thumbnails": 0,
                "captions": 0,
                "descriptions": 0,
                "metadata": 0,
                "dependent": 0,
                "still_image": 0
            },
            "tags": {
                "DURATION": "00:00:10.021000000"
            }
        }
    ]
}
"""

import math
import pathlib
import re
import json
import typing
import atexit
import subprocess

from FFmpegTask.utils.process_utils import close_subprocess_process


class _Stream(object):
    index: int

    codec_name: str
    codec_long_name: str
    codec_type: str

    duration_hour: int
    duration_minute: int
    duration_second: int
    duration_microsecond: int

    def __init__(self, info: dict):
        self.index = info["index"]

        self.codec_name = info["codec_name"]
        self.codec_long_name = info["codec_long_name"]
        self.codec_type = info["codec_type"]

        if info["tags"].get("DURATION") is None:
            duration = info["duration"]
            duration_re = r"(\d+)\.(\d{0,3})"
            duration_re_result = re.search(duration_re, duration)
            second, microsecond = duration_re_result.groups()
            self.duration_hour = 0
            self.duration_minute = 0
            self.duration_second = int(second)
            self.duration_microsecond = int(microsecond)
        else:
            duration = info["tags"]["DURATION"]
            duration_re = r"(\d+):(\d+):(\d+)\.(\d{0,3})"
            duration_re_result = re.search(duration_re, duration)
            hour, minute, second, microsecond = duration_re_result.groups()
            self.duration_hour = int(hour)
            self.duration_minute = int(minute)
            self.duration_second = int(second)
            self.duration_microsecond = int(microsecond)

    def __str__(self) -> str:
        return f"" \
               f"index: {self.index}, " \
               f"codec_name:{self.codec_name}, " \
               f"codec_long_name: {self.codec_long_name}, " \
               f"codec_type: {self.codec_type}, " \
               f"duration: {self.duration_hour}.{self.duration_minute}.{self.duration_second}.{self.duration_microsecond}"


class VideoStream(_Stream):
    width: int
    height: int

    r_frame_rate: int
    avg_frame_rate: int

    sample_aspect_ratio: str
    display_aspect_ratio: str

    pix_fmt: str

    color_range: str
    color_space: str
    color_transfer: str
    color_primaries: str

    chroma_location: str

    field_order: str

    def __init__(self, info: dict):
        super().__init__(info)

        self.width = info["width"]
        self.height = info["height"]

        self.r_frame_rate = int(info["r_frame_rate"][:-2])
        self.avg_frame_rate = int(info["avg_frame_rate"][:-2])

        self.sample_aspect_ratio = info["sample_aspect_ratio"]
        self.display_aspect_ratio = info["display_aspect_ratio"]

        self.pix_fmt = info["pix_fmt"]

        self.color_range = info["color_range"]
        self.color_space = info["color_space"]
        self.color_transfer = info["color_transfer"]
        self.color_primaries = info["color_primaries"]

        if info.get("chroma_location") is not None:
            self.chroma_location = info["chroma_location"]

        self.field_order = info["field_order"]


class AudioStream(_Stream):
    sample_fmt: str
    sample_rate: int

    def __init__(self, info: dict):
        super().__init__(info)


class SubtitleStream(_Stream):
    def __init__(self, info: dict):
        super().__init__(info)


def _get_stream(info: dict, codec_type: typing.Literal["video", "audio", "subtitle"]) -> list:
    stream_list = []

    for stream in info["streams"]:
        if stream["codec_type"] != codec_type:
            continue
        else:
            if codec_type == "video":
                stream = VideoStream(stream)
            elif codec_type == "audio":
                stream = AudioStream(stream)
            elif codec_type == "subtitle":
                stream = SubtitleStream(stream)
            stream_list.append(stream)

    return stream_list


def get_video_stream(info: dict) -> list[VideoStream]:
    return _get_stream(info, "video")


def get_audio_stream(info: dict) -> list[AudioStream]:
    return _get_stream(info, "audio")


def get_subtitle_stream(info: dict) -> list[SubtitleStream]:
    return _get_stream(info, "subtitle")


def get_info(input_file: pathlib.Path) -> dict:
    ffprobe_command = f"ffprobe -v error -show_streams -print_format json {input_file}"

    process = subprocess.Popen(args=ffprobe_command, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, universal_newlines=True, shell=False, text=True)
    atexit.register(close_subprocess_process(process, kill=True))

    json_str = ""
    for char in process.stdout:
        json_str += char
    json_obj = json.loads(json_str)

    return json_obj


class FFMPEGInfo(object):
    input_file: pathlib.Path

    video_info: dict

    video_streams: list[VideoStream]
    audio_streams: list[AudioStream]
    subtitle_streams: list[SubtitleStream]

    def __str__(self) -> str:
        result = f"{self.input_file}\n"

        result += "video_streams:\n"
        for stream in self.video_streams:
            result += f"    {stream}\n"

        result += "audio_streams:\n"
        for stream in self.audio_streams:
            result += f"    {stream}\n"

        result += "subtitle_streams:\n"
        for stream in self.subtitle_streams:
            result += f"    {stream}\n"

        return result

    def __init__(self, input_file: pathlib.Path):
        self.input_file = input_file

        self.video_info = get_info(self.input_file)

        self.video_streams = get_video_stream(self.video_info)
        self.audio_streams = get_audio_stream(self.video_info)
        self.subtitle_streams = get_subtitle_stream(self.video_info)

    @property
    def total_second(self) -> float:
        video_stream = self.video_streams[0]
        return video_stream.duration_hour * 60 * 60 + video_stream.duration_minute * 60 + video_stream.duration_second + video_stream.duration_microsecond / 1000

    @property
    def total_frame(self) -> int:
        video_stream = self.video_streams[0]
        return math.ceil(video_stream.avg_frame_rate * self.total_second)
